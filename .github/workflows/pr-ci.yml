---
name: ğŸš€ CI on Pull Request
on:
  pull_request:
    branches: [main, master]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  checks: write

env:
  GO_VERSION: '~1.23'
  GOLANGCI_LINT_VERSION: v1.63.4
  GORELEASER_VERSION: '~> v2'

jobs:
  # Fast feedback loop: Code Quality Checks
  code-quality:
    name: ğŸ§ Code Quality
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: âš™ï¸ Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: false

    - name: ğŸ§¹ Go Format
      run: |
        echo "ğŸ–Œï¸ Checking code formatting..."
        gofmt -d .
        if [ -n "$(gofmt -d .)" ]; then
          echo "âŒ Code is not formatted correctly. Run 'go fmt ./...' to fix."
          exit 1
        fi

    - name: ğŸ” Golangci-Lint
      uses: golangci/golangci-lint-action@v6
      with:
        version: ${{ env.GOLANGCI_LINT_VERSION }}
        args: --timeout=5m --config=./.golangci.yml
        github-token: ${{ secrets.GITHUB_TOKEN }}

  # Build and Test Job
  build-and-test:
    name: ğŸ—ï¸ Build & Test
    needs: [code-quality]
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: âš™ï¸ Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: false

    - name: ğŸ“¦ Get Dependencies
      run: |
        go mod tidy
        go mod download

    - name: ğŸ—ï¸ Build CLI
      run: |
        cd cli
        go build -o aws-taggy

    - name: ğŸ§ª Run Unit Tests
      run: |
        go test -race -coverprofile="coverage.out" -covermode=atomic ./...

  # CLI Functionality Test
  cli-test:
    name: ğŸ–¥ï¸ CLI Functionality
    needs: [build-and-test]
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: âš™ï¸ Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸ—ï¸ Build CLI
      run: |
        cd cli
        go build -o aws-taggy

    - name: ğŸ” Test CLI Help Command
      run: |
        ./cli/aws-taggy --help

  # Pre-commit Hooks
  pre-commit:
    name: ğŸ§¼ Pre-commit Hooks
    needs: [cli-test]
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: âš™ï¸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ğŸ”§ Install Pre-commit
      run: |
        pip install pre-commit
        pre-commit install

    - name: ğŸ§¹ Run Pre-commit Hooks
      run: pre-commit run --all-files

  # Snapshot Release (Dry Run)
  goreleaser-snapshot:
    name: ğŸ“¦ GoReleaser Snapshot
    needs: [pre-commit]
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: âš™ï¸ Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: ğŸš€ Run GoReleaser Snapshot
      uses: goreleaser/goreleaser-action@v6
      with:
        distribution: goreleaser
        version: ${{ env.GORELEASER_VERSION }}
        args: release --snapshot --clean
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Final Status Check
  pr-validation:
    name: âœ… PR Validation
    needs: [goreleaser-snapshot]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: ğŸ‰ PR Ready to Merge
      run: |
        if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
          echo "âŒ Some checks failed. Please review and fix."
          exit 1
        else
          echo "âœ… All checks passed successfully!"
        fi
